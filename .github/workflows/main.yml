name: RDP Master - Generate & Scan

on:
  workflow_dispatch:
    inputs:
      country_code:
        description: 'كود الدولة (مثل: us, sa, eg)'
        required: true
        default: 'us'
      limit_per_block:
        description: 'عدد الآي بيهات من كل بلوك (all أو رقم)'
        required: true
        default: '10'
      port:
        description: 'المنفذ (RDP Port)'
        required: true
        default: '3389'
      threads:
        description: 'عدد الخيوط للفحص (Threads)'
        required: true
        default: '500'
      timeout:
        description: 'وقت المهلة (Timeout)'
        required: true
        default: '5'

jobs:
  ultra_process:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Environment (Python & Go)
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install Python Dependencies
        run: pip install requests colorama ipaddress

      - name: Step 1: Generate IPs (Python)
        run: |
          # محاكاة إدخال سكريبت التوليد:
          # 3 (وضع الدولة) -> كود الدولة -> 2 (استخراج عينات) -> العدد -> n (بدون بينج هنا لتوفير الوقت)
          printf "3\n${{ github.event.inputs.country_code }}\n2\n${{ github.event.inputs.limit_per_block }}\nn\n" | python main.py
          echo "✅ IPs Generated in IP.txt"

      - name: Step 2: Scan IPs (Go)
        run: |
          # محاكاة إدخال سكريبت الفحص:
          # y (استخدام الملف) -> المنفذ -> الثريدز -> التايم آوت
          printf "y\n${{ github.event.inputs.port }}\n${{ github.event.inputs.threads }}\n${{ github.event.inputs.timeout }}\n" | go run main.go

      - name: Step 3: Upload All Results
        uses: actions/upload-artifact@v4
        with:
          name: RDP-Scan-${{ github.event.inputs.country_code }}-${{ github.run_id }}
          path: |
            IP.txt
            nla.txt
            nonla.txt
            error.txt
            timeout.txt
          if-no-files-found: warn

      - name: Step 4: Zip Backups (If any)
        if: always()
        run: |
          if ls -d nla_backup_* 1> /dev/null 2>&1; then
            zip -r backups.zip nla_backup_*
            echo "BACKUP_EXISTS=true" >> $GITHUB_ENV
          fi

      - name: Upload Backups
        if: env.BACKUP_EXISTS == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: rdp-backups-${{ github.run_id }}
          path: backups.zip
